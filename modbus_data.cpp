#include "modbus_data.h"

uint8_t CModbus_Data::s_cmds[][8] = {
    { 0xf7, 0x03, 0x17, 0x30, 0x00, 0x14 },
    { 0xf7, 0x03, 0x17, 0x7F, 0x00, 0x11 },
    { 0xf7, 0x03, 0x10, 0x41, 0x00, 0x02 },
    { 0xf7, 0x03, 0x16, 0x14, 0x00, 0x04 },
    { 0xf7, 0x03, 0x12, 0x15, 0x00, 0x03 },
    { 0xf7, 0x03, 0x16, 0x70, 0x00, 0x0D },
    { 0xf7, 0x03, 0x12, 0x1C, 0x00, 0x14 },
    { 0xf7, 0x03, 0x17, 0x58, 0x00, 0x09 },
    { 0xf7, 0x03, 0x12, 0x33, 0x00, 0x11 },
    { 0xf7, 0x03, 0x17, 0x61, 0x00, 0x0B },
    { 0xf7, 0x03, 0x16, 0x52, 0x00, 0x02 },
    { 0xf7, 0x03, 0x16, 0xA0, 0x00, 0x08 },
    { 0xf7, 0x03, 0x17, 0x44, 0x00, 0x14 },
    { 0xf7, 0x03, 0x16, 0x90, 0x00, 0x0E },
    { 0xf7, 0x03, 0x17, 0x6C, 0x00, 0x13 },
    { 0xf7, 0x03, 0x17, 0x06, 0x00, 0x12 },
    { 0xf7, 0x03, 0x17, 0x18, 0x00, 0x10 },
    { 0xf7, 0x03, 0x17, 0x28, 0x00, 0x08 },
    { 0xf7, 0x03, 0x16, 0xF2, 0x00, 0x14 }
};

int CModbus_Data::s_iCount = 0;

CModbus_Data::CModbus_Data()
{

}

void CModbus_Data::init(void)
{
    uint16_t crc = 0;

    s_iCount = sizeof(s_cmds) / sizeof(s_cmds[0]);
    for (int i = 0; i < s_iCount; ++i)
    {
        crc = crc_cal_value(s_cmds[i], sizeof(s_cmds[0]) - sizeof(uint16_t));
        s_cmds[i][6] = 0xff & crc;
        s_cmds[i][7] = 0xff & (crc >> 8);
    }
}

uint16_t CModbus_Data::crc_cal_value(unsigned char*data_value, int data_length)
{
    int i = 0;
    uint16_t crc_value = 0xffff;
    while (data_length--)
    {
        crc_value ^= *data_value++;
        for (i = 0; i < 8; i++)
        {
            if (crc_value & 0x0001)
            {
                crc_value = (crc_value >> 1) ^ 0xa001;
            }
            else
            {
                crc_value = crc_value >> 1;
            }
        }
    }

    return crc_value;
}
